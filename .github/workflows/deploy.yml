name: Deploy Infra Stack

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy via SSH
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            DEPLOY_DIR="/opt/infra-stack"

            # Clone or pull latest
            if [ ! -d "$DEPLOY_DIR/.git" ]; then
              git clone https://github.com/suryansh-business-work/common-services.git "$DEPLOY_DIR"
            else
              cd "$DEPLOY_DIR"
              git fetch origin main
              git reset --hard origin/main
            fi

            cd "$DEPLOY_DIR"

            # Create .env from example if missing
            if [ ! -f .env ]; then
              cp .env.example .env
              echo "⚠️  Created .env from .env.example — edit with real values!"
            fi

            # Create n8n database in PostgreSQL if needed
            docker compose -f compose/all.yml up -d postgresql
            sleep 5
            docker exec infra-postgresql psql -U admin -d infra -c "SELECT 1 FROM pg_database WHERE datname='n8n'" | grep -q 1 || \
              docker exec infra-postgresql psql -U admin -d infra -c "CREATE DATABASE n8n;"

            # Pull latest images and (re)start everything
            docker compose -f compose/all.yml pull
            docker compose -f compose/all.yml up -d --remove-orphans

            # Cleanup dangling images
            docker image prune -f

            echo "✅ Infra Stack deployed successfully"
            docker compose -f compose/all.yml ps
